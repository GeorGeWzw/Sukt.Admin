name: Sukt.Core.API
on:
  push:
    branches: [dev/suktauthserver]
  pull_request:
    branches: [dev/suktauthserver]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
    - name: dotnet restore
      run: dotnet restore src/Sukt.Core.API
    - name: dotnet publish
      run: dotnet publish src/Sukt.Core.API --configuration -c Release --no-restore -o app  
    - name: Login To Docker
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.ALIYUN_DOCKER_IMAGESTORE_USERNAME }}
        password: ${{ secrets.ALIYUN_DOCKER_IMAGESTORE_PASSWORD }}
        registry: registry.cn-hangzhou.aliyuncs.com/suktcore/sukt-core-admin-api
    - name: Run Crrpath
      run: ls 
    - name: Copy Dockerfile 
      run: cp Dockerfile /home/runner/work/Sukt.Core/Sukt.Core/app
    - name: Run path
      run: ls /home/runner/work/Sukt.Core/Sukt.Core/app
    - name: Build Docker Image
      uses: docker/build-push-action@v2
      with:
        tags: registry.cn-hangzhou.aliyuncs.com/suktcore/sukt-core-admin-api:v1.6 
        context: /home/runner/work/Sukt.Core/Sukt.Core/app
        file: /home/runner/work/Sukt.Core/Sukt.Core/app/Dockerfile
        push: true
      # run: |
      #   docker version
      #   # 登录到阿里云镜像仓库
      #   sudo docker login --username=${{secrets.ALIYUN_DOCKER_IMAGESTORE_USERNAME}} --password=${{ secrets.ALIYUN_DOCKER_IMAGESTORE_PASSWORD }} registry.cn-hangzhou.aliyuncs.com
      #   docker build  --tag  registry.cn-hangzhou.aliyuncs.com/suktcore/sukt-core-admin-api:v1.6 -f Dockerfile ..
